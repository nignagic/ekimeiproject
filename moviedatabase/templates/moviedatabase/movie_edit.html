{% extends 'moviedatabase/base.html' %}

{% block title %}動画・パート情報編集 - {{ movie }}{% endblock %}

{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'moviedatabase/part_edit.css' %}">
{% for m in movies %}{{ m }}<br>{% endfor %}
<form name="part_add" method="post">
	<h2>動画情報編集</h2>
	<div class="main-container">
		<div class="movie-detail">
			<div class="youtube-container">
				<div class="youtube">
					<div id="player"></div>
					<script>
						var tag = document.createElement('script');

						tag.src = "https://www.youtube.com/iframe_api";
						var firstScriptTag = document.getElementsByTagName('script')[0];
						firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

						var player;
						function onYouTubeIframeAPIReady() {
							player = new YT.Player('player', {
								    videoId: '{{ movie.youtube_id }}',
							})
						}

						$(document).on('click', '.time-set', function() {
							t = parseInt(player.getCurrentTime())
							$(this).prev('.start_time').val(inttosecond(t))
						})
						function inttosecond(t) {
							s = (t % 60) % 60
							if (s < 10) s = "0" + s
							m = Math.floor(t / 60) % 60
							if (m < 10) m = "0" + m
							h = Math.floor(t / 3600)
							if (h < 10) h + "0" + h
							return h + ":" + m + ":" + s
						}
					</script>
				</div>
			</div>
			<div class="detail-original">
				<a href="https://www.youtube.com/watch?v={{ movie.youtube_id }}" target="_blank" class="movie-title-link"><h2 class="movie-title">{{ movie.title }}</h2></a>
				{{ form.title }}
				{{ form.main_id }}
				{{ form.youtube_id }}
				{{ form.niconico_id }}
				{{ form.published_at }}
				{{ form.duration }}
				{{ form.n_view }}
				{{ form.n_like }}
				{{ form.n_dislike }}
				{{ form.n_comment }}
				{{ form.description }}
				{{ form.reg_date }}
				<div class="movie-channel">
					<div class="movie-channel-img">
						<img src="url">
					</div>
					<div class="movie-channel-name">{{ movie.channel }}</div>
				</div>
				{{ form.channel }}
				<h3 class="detail-header">投稿日時</h3>
				<div class="detail-content">
					{% load tz %}
					<p class="movie-published-jpn">{{ movie.published_at|timezone:'Asia/Tokyo'|date:"Y年n月d日 H:i:s" }} <small>(日本時間)</small></p>
				</div>
			</div>
			<div class="detail-addition">
				<h3 class="detail-header">単合区分</h3>
				<div class="detail-content">
					{{ form.is_collab }}
				</div>
				<h3 class="detail-header">使用楽曲(全体)</h3>
				<div class="detail-content">
					{{ form.song }}
		<a href="javascript:void(0);" onclick="window.open('{% url 'songdata:popup_song_create' %}', 'subwin', 'width=500,height=500');">+Song</a>
				</div>
				<h3 class="detail-header">親作品</h3>
				<div class="detail-content">
					{{ form.parent }}
				</div>
				<h3 class="detail-header">関連作品</h3>
				<div class="detail-content">
					{{ form.related }}
				</div>
				<h3 class="detail-header">補足説明</h3>
				<div class="detail-content">
					{{ form.explanation }}
				</div>
				<h3 class="detail-header">概要</h3>
				<div class="detail-content movie-description">
					{{ movie.description | urlize | linebreaksbr }}
				</div>
			</div>
		</div>
		<div class="movie-part-list">
			{% if partcount == 0 %}
			<input type="radio" name="part-division" value="single" checked="">　パート分けなし<br>
			<input type="radio" name="part-division" value="multiple">　パート分けあり
			{% else %}
				{% for part in parts %}
				<div class="part-header" {% if onlyonepart %}style="display: none;"{% endif %}>
					<div class="part-name-short"><span>{{ part.short_name }}</span></div>
					<table class="part-table" data-part_id="{{ part.id }}" data-category="{{ part.category }}">
						<tr>
							<td class="part-header-up">
								{{ part.name }}
							</td>
						</tr>
						<tr class="row-2">
							<td>
								{% if part.participant.all %}
									{% for participant in part.participant.all %}
										{{ participant }}
										{% if forloop.last %}
										{% else %}
											<span>/</span>
										{% endif %}
									{% endfor %}
									{% endif %}
								{% if part.song.all %}
								 - 
									{% for song in part.song.all %}
										{{ song }}
										{% if forloop.last %}
										{% else %}
											<span>/</span>
										{% endif %}
									{% endfor %}
								{% endif %}
							</td>
						</tr>
					</table>
				</div>
				{% endfor %}
			{% endif %}
			<input type="radio" name="part-division" value="exist" style="display: none;">
		</div>
	</div>
	<div class="submit-button">
		{% csrf_token %}
		<button type="button" onclick="submit();" class="btn btn-primary">送信</button>
	</div>
</form>
{% endblock %}

{% block extrajs %}
<script type="text/javascript">
	$(function() {
		d = $('.movie-description').text().replace(/<br>/g, '<br>');
		$('.movie-description').html(d)
	})
</script>
{% endblock %}